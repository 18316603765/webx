# 命令与生命周期挂钩 {#concept_1580318 .concept}

Web+通过自定义启停命令和生命周期挂钩等功能提供了扩展能力，您可以很方便的通过这些功能来改写或干预默认的服务管理动作从而满足各种定制化的需求。

## 进入命令或生命周期挂钩配置页面 {#section_yjd_zx7_ms0 .section}

在创建新部署环境和修改正在运行的部署环境配置时，您都可以对命令或生命周期挂钩的配置进行修改。

创建应用及部署环境时

1.  登录[Web+控制台](https://webplus.console.aliyun.com)。
2.  在**概览**页**最近更新的部署环境**区域的右上角单击**新建**，根据页面提示完成**应用基本信息**和**部署环境信息**设置后进入部署环境**配置**页面。
3.  在部署环境**配置**页面选择**预设配置**模式为**自定义**。
4.  在展开的配置页面上，选择资源分类下的**命令**或**生命周期挂钩**并进行配置。
5.  单击**完成创建**将新建部署环境。

选择已有应用创建部署环境时

1.  登录[Web+控制台](https://webplus.console.aliyun.com)。
2.  在**概览**页**最近更新的部署环境**区域的右上角单击**查看全部**。
3.  在**应用及部署环境**页面单击要新建环境的应用的ID。
4.  在应用详情**概览**页面右上角单击**创建部署环境**，设置部署环境信息后进入**配置**页面。
5.  在部署环境**配置**页面选择**预设配置**模式为**自定义**。
6.  在展开的配置页面上，选择资源分类下的**命令**或**生命周期挂钩**并进行配置。
7.  单击**完成创建**将新建部署环境。

更改部署环境时

1.  登录[Web+控制台](https://webplus.console.aliyun.com)。
2.  在**概览**页**最近更新的部署环境**区域的右上角单击**查看全部**。
3.  在**应用及部署环境**页面单击所选应用最左侧的 ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/163212/156514845447117_zh-CN.png)展开应用所关联的环境列表。
4.  选择并单击部署环境名称进入部署环境**概览**页面。
5.  在左侧导航栏单击**配置**进入环境配置页面。
6.  在展开的配置页面上，选择资源分类下的**命令**或**生命周期挂钩**并进行配置。
7.  单击**变更配置**将更新部署环境。

## 命令 {#section_pks_hk7_jtq .section}

通常情况下，Web+对于每种技术栈类型设置了默认的启动与停止命令，Web+默认使用systemd来管理用户的服务进程。

![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/1253418/156514845554624_zh-CN.png)

**说明：** 

-   启动命令必须一直以前台运行，命令执行结束时服务即停止。
-   停止命令建议总是包含systemctl stop wpweb，以确保可以正常停止服务，可在此命令前后增加自定义的处理的部分。
-   启动命令的工作目录为应用部署包的根目录。
-   启动命令将以admin用户身份执行。
-   如果部署包内提供了Procfile，则指定的启动命令将不会生效。

## 生命周期挂钩 {#section_a5a_gco_j8t .section}

在Web+执行实例变更动作时，可以触发特定的生命周期挂钩，您可以在这些生命周期挂钩上设置执行的命令或脚本，来完成如修改配置文件，注册/注销服务，发送通知，下载文件等常见的特定操作。

-   PostPrepareEnv：环境初始化后此挂钩将被执行，一个实例只会运行一次，执行该挂钩时不可读取环境变量。
-   PreInstallStack：技术栈所含基础软件安装或变更前此挂钩将被执行，执行该挂钩时不可读取环境变量。
-   PostInstallStack：技术栈所含基础软件安装或变更前后挂钩将被执行，执行该挂钩时不可读取环境变量。
-   PrePrepareApp：应用发生变更（如部署包版本发生变化）前该挂钩将被执行，执行该挂钩时不可读取环境变量。
-   PostPrepareApp：应用发生变更（如部署包版本发生变化）后该挂钩将被执行，执行该挂钩时可以使用环境变量。
-   PreStart：服务启动前该挂钩将被被执行，执行该挂钩可以使用环境变量。
-   PostStart：服务启动后该挂钩将被被执行，执行该挂钩可以使用环境变量。
-   PreStop：服务停止前该挂钩将被执行，执行该挂钩可以使用环境变量。
-   PostStop：服务停止后该挂钩将被执行，执行该挂钩可以使用环境变量。

**说明：** 

-   生命周期挂钩将以root用户身份执行。
-   生命周期挂钩的执行失败将导致变更失败并终止，如果您不希望生命周期挂钩影响变更流程，可以在命令行的末尾添加;exit 0来保证执行总是成功。
-   部分生命周期挂钩中可以使用环境变量，可用的环境变量见《环境变量》。
-   生命周期挂钩需要在2分钟内执行完成，否则会导致变更失败并终止，如果有超长的任务需要处理，建议通过后台执行脚本的方式来完成。
-   生命周期挂钩的工作目录为/opt/webplus/data/envdata/wproot/，您可以通过cd命令来切换到指定的目录下。
-   建议在生命周期挂钩中使用命令或脚本的绝对路径。

